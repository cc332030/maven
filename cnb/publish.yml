
jdk-version: 21

.publish: &publish
  - env:
      JDK_VERSION: !reference [jdk-version]
      NEXUS_USERNAME: ${CNB_TOKEN_USER_NAME}
      NEXUS_PASSWORD: ${CNB_TOKEN_ARTIFACTORY}
    services:
      - docker
    docker:
      image: ibm-semeru-runtimes:open-${JDK_VERSION}-jdk
      volumes:
        - maven-wrapper:/root/.m2/wrapper:copy-on-write
        - ${CNB_REPO_NAME}-${JDK_VERSION}:/root/.m2/repository:copy-on-write
    stages:
      - name: init-maven
        imports: https://cnb.cool/${CNB_GROUP_SLUG}/secrets/-/blob/main/secrets.yml
        script: |
          curl -sL https://github.com/cc332030/maven/raw/master/script/linux/init-maven.sh | sh
        env:
          NEXUS_ID: ${CNB_GROUP_SLUG}
          MAVEN_CENTRAL: https://mirrors.cloud.tencent.com/nexus/repository/maven-public/

          NEXUS_SNAPSHOT_USERNAME: ${NEXUS_USERNAME}
          NEXUS_SNAPSHOT_PASSWORD: ${NEXUS_PASSWORD}
          NEXUS_SNAPSHOT_ID: ${CNB_GROUP_SLUG}-snapshot
          NEXUS_SNAPSHOT_URL: https://maven.cnb.cool/${CNB_GROUP_SLUG}/maven-snapshot/-/packages/

          NEXUS_RELEASE_USERNAME: ${NEXUS_USERNAME}
          NEXUS_RELEASE_PASSWORD: ${NEXUS_PASSWORD}
          NEXUS_RELEASE_ID: ${CNB_GROUP_SLUG}-release
          NEXUS_RELEASE_URL: https://maven.cnb.cool/${CNB_GROUP_SLUG}/maven-release/-/packages/

      - name: publish
        script: |
          CORE_NUM=$(grep -c ^processor /proc/cpuinfo)
          echo "CORE_NUM=${CORE_NUM}"
          
          sh mvnw -T ${CORE_NUM}C clean deploy -U

        env:
          NEXUS_SNAPSHOT_ID: ${CNB_GROUP_SLUG}-snapshot
          NEXUS_SNAPSHOT_URL: https://maven.cnb.cool/${CNB_GROUP_SLUG}/maven-snapshot/-/packages/
          NEXUS_RELEASE_ID: ${CNB_GROUP_SLUG}-release
          NEXUS_RELEASE_URL: https://maven.cnb.cool/${CNB_GROUP_SLUG}/maven-release/-/packages/

    endStages:
      - name: init-maven-clean
        script: |
          curl -sL https://github.com/cc332030/maven/raw/master/script/linux/init-maven-clean.sh | sh

"(main|master)":
  pull_request:
    - <<: *publish
  push:
    - <<: *publish
$:
  tag_push:
    - <<: *publish
